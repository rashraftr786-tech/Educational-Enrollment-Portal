<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>100% Enrollment - Dropout Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f4f7f6; padding: 15px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .household-card { background: #fff; border-top: 5px solid #0d6efd; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .member-card { background: #ffffff; border-left: 5px solid #ffc107; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #eee; position: relative; }
        .dropout-section { background: #fff3f3; border: 1px dashed #dc3545; padding: 10px; border-radius: 8px; margin-top: 10px; display: none; }
        .stats-banner { background: #212529; color: white; padding: 10px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-around; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container" style="max-width: 900px;">
    <div class="text-center mb-3">
        <h2 class="fw-bold">üéì Education Census Portal</h2>
        <span class="badge bg-primary">Automated ID System Active</span>
    </div>

    <div class="stats-banner">
        <div>üè† Houses: <span id="houseCount">0</span></div>
        <div>üë• Individuals: <span id="personCount">0</span></div>
    </div>
    
    <div class="household-card">
        <h5 class="text-primary mb-3">üìç Location & Household</h5>
        <div class="row g-2">
            <div class="col-6">
                <label class="small fw-bold">Household Number</label>
                <input type="text" id="houseId" class="form-control bg-light" readonly>
            </div>
            <div class="col-6">
                <label class="small fw-bold">Mohallah / Habitation</label>
                <input type="text" id="habitation" class="form-control" placeholder="Enter Area Name">
            </div>
            <div class="col-12 mt-2">
                <input type="text" id="headName" class="form-control" placeholder="Head of Household Name">
            </div>
        </div>
    </div>

    <div id="membersContainer"></div>

    <div class="d-grid gap-2 mb-5">
        <button class="btn btn-warning btn-lg fw-bold" onclick="addMember()">+ Add Family Member</button>
        <button class="btn btn-primary btn-lg" onclick="saveHousehold()">‚úÖ Save Household & Next</button>
        <hr>
        <button class="btn btn-success" onclick="exportToExcel()">üìä Download Final Excel Sheet</button>
        <button class="btn btn-outline-danger btn-sm mt-3" onclick="clearDatabase()">Reset Database</button>
    </div>
</div>

<script>
    let masterDatabase = JSON.parse(localStorage.getItem('eduSurveyData')) || [];
    
    // Auto-Generate House ID logic
    function generateHouseID() {
        const lastHouse = masterDatabase.length > 0 ? masterDatabase[masterDatabase.length - 1].HouseID : "H-1000";
        const lastNum = parseInt(lastHouse.split('-')[1]);
        document.getElementById('houseId').value = `H-${lastNum + 1}`;
    }

    function updateCounters() {
        document.getElementById('houseCount').innerText = [...new Set(masterDatabase.map(d => d.HouseID))].length;
        document.getElementById('personCount').innerText = masterDatabase.length;
    }

    function addMember() {
        const container = document.getElementById('membersContainer');
        const memberId = Date.now();
        const div = document.createElement('div');
        div.className = 'member-card';
        div.innerHTML = `
            <div class="row g-2">
                <div class="col-7"><input type="text" class="form-control memName" placeholder="Name"></div>
                <div class="col-5"><input type="number" class="form-control memAge" placeholder="Age" onchange="handleAgeLogic(this)"></div>
            </div>

            <div class="mt-2 row g-2">
                <div class="col-6">
                    <select class="form-select memStatus" onchange="toggleDropout(this)">
                        <option value="Enrolled">Currently Enrolled</option>
                        <option value="Dropout">Dropout</option>
                        <option value="Never Enrolled">Never Enrolled</option>
                    </select>
                </div>
                <div class="col-6">
                    <select class="form-select memAgeDoc">
                        <option value="">Age Proof?</option>
                        <option value="Birth Certificate">Birth Cert</option>
                        <option value="Hospital Record">Hospital Rec</option>
                        <option value="Aadhar/ID">Aadhar/ID</option>
                        <option value="Declaration">Self-Declaration</option>
                    </select>
                </div>
            </div>

            <div class="dropout-section">
                <label class="small fw-bold text-danger">Dropout Details</label>
                <input type="text" class="form-control form-control-sm mb-2 prevEdu" placeholder="Last Class Completed">
                <textarea class="form-control form-control-sm mb-2 discReason" placeholder="Reason for discontinuation?"></textarea>
                <select class="form-select form-select-sm willingJoin">
                    <option value="">Willing to join again?</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                    <option value="Requires Counseling">Requires Counseling</option>
                </select>
            </div>
        `;
        container.appendChild(div);
    }

    function handleAgeLogic(input) {
        const age = input.value;
        const card = input.closest('.member-card');
        if (age < 3 || age > 18) {
            card.style.borderLeft = "5px solid #6c757d"; // Adult/Toddler color
        } else {
            card.style.borderLeft = "5px solid #ffc107"; // School age color
        }
    }

    function toggleDropout(select) {
        const dropoutDiv = select.closest('.member-card').querySelector('.dropout-section');
        dropoutDiv.style.display = (select.value === 'Dropout' || select.value === 'Never Enrolled') ? 'block' : 'none';
    }

    function getAgeGroup(age) {
        if (age <= 3) return "0-3"; if (age <= 6) return "3-6"; if (age <= 14) return "6-14";
        if (age <= 18) return "14-18"; return "18+";
    }

    function saveHousehold() {
        const hId = document.getElementById('houseId').value;
        const area = document.getElementById('habitation').value;
        const hHead = document.getElementById('headName').value;
        const cards = document.querySelectorAll('.member-card');

        if(!area || cards.length === 0) { alert("Area and Family Member details required!"); return; }

        cards.forEach(card => {
            masterDatabase.push({
                "HouseID": hId,
                "Mohallah_Habitation": area,
                "HeadOfHouse": hHead,
                "Name": card.querySelector('.memName').value,
                "PresentAge": card.querySelector('.memAge').value,
                "AgeGroup": getAgeGroup(card.querySelector('.memAge').value),
                "AgeSupportDoc": card.querySelector('.memAgeDoc').value,
                "EnrollmentStatus": card.querySelector('.memStatus').value,
                "LastClassCompleted": card.querySelector('.prevEdu').value || "N/A",
                "ReasonForDiscontinue": card.querySelector('.discReason').value || "N/A",
                "WillingToRejoin": card.querySelector('.willingJoin').value || "N/A"
            });
        });

        localStorage.setItem('eduSurveyData', JSON.stringify(masterDatabase));
        alert("Household Recorded!");
        location.reload(); // Resets form and increments House ID
    }

    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(masterDatabase);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "CensusData");
        XLSX.writeFile(wb, "Community_Education_Census.xlsx");
    }

    function clearDatabase() {
        if(confirm("Erase all stored data?")) { localStorage.removeItem('eduSurveyData'); location.reload(); }
    }

    window.onload = () => { generateHouseID(); updateCounters(); };
</script>
</body>
</html>
        
